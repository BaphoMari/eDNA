---
title: "edna"
author: "Chris Kracha"
date: "06/30/2022"
output: html
---

```{r setup}

library(taxa)
library(metacoder)
library(plyr)
library(janitor)
library(here)
library(tidyverse)

```

# Aquatic Invertebrates

## Load in data
```{r clean batch eDNA}

# Function cleans and combines all eDNA files from a folder
eDNA_clean <- function(folder) {
  
  cleaned <- folder %>%
    
    # Create list of all files in target folder
    list.files(full.names = TRUE)  %>%
    
    # Read CSV files and bind rows together
    ldply(read_csv) %>% 
    
    # Remove special characters from column names
    dplyr::rename(percent_match = "% match",
           number_species = "# species") %>%
    
    # Combine taxa into one column
    unite("kpcofgs", Kingdom:Species, 
          sep = ", ", na.rm = TRUE, 
          remove = FALSE) %>%
    
    select(1:number_species, kpcofgs, everything()) %>%
    
    # Switch to long format, where vials are rows not columns
    pivot_longer(cols = 14:ncol(.), 
                 names_to = "sample_id", 
                 values_to = "sample_count") %>%
    
    # Remove rows with no sample count
    filter(sample_count != 0)
  
  return(cleaned)
}
```

```{r join aquatic eDNA to metadata, message=FALSE, include=FALSE}

# Metadata file (should be updated with each batch)
# NOTE: Original file edited due to errors in copying 1s/Is and Os/0s
AQsampleIDs <- read_csv(here("data/sample_ids.csv")) %>%
  clean_names()

# 1470 eDNA data with site names
folder1470 <- here::here("data/JVB1470")

JVB1470 <- eDNA_clean(folder1470) %>%
  left_join(AQsampleIDs, by = c("sample_id" = "barcode")) %>%
  
  # Alcohol sample info added manually - dates are approximate
  mutate(site = case_when(sample_id == "S034210" ~ "MO1",
                          sample_id == "S034179" ~ "NVBR",
                          TRUE ~ site),
         date = case_when(sample_id == "S034210" ~ mdy("11/16/2021"),
                          sample_id == "S034179" ~ mdy("11/16/2021"),
                          TRUE ~ mdy(date)),
         ncos_or_copr = 
                 case_when(sample_id == "S034210" ~ "COPR",
                           sample_id == "S034179" ~ "NCOS",
                           TRUE ~ ncos_or_copr),
         full_site_name = 
                 case_when(sample_id == "S034210" ~ "Mouth",
                           sample_id == "S034179" ~ "Venoco Bridge",
                           TRUE ~ full_site_name)) %>%
  filter(site != "", kpcofgs != "")
  
# 1554 eDNA
folder1554 <- here::here("data/JVB1554")

info1554 <- read.csv(here::here("data/info_1554.csv")) %>% clean_names()

JVB1554 <- eDNA_clean(folder1554) %>%
  left_join(AQsampleIDs, by = c("sample_id" = "barcode")) %>%
  mutate(date = mdy(date)) %>%
  filter(site != "", kpcofgs != "")

# 1703 eDNA data joined to metadata
folder1703 <- here::here("data/JVB1703")

info1703 <- read_csv(here::here("data/info_1703.csv")) %>% clean_names()

JVB1703 <- eDNA_clean(folder1703) %>% 
  mutate(sample_id = gsub("\\.1", "", sample_id)) %>%
  left_join(AQsampleIDs, by = c("sample_id" = "barcode")) %>%
  mutate(date = mdy(date)) %>%
  filter(site != "", kpcofgs != "")

```

```{r bind eDNA batches}

NCOS_AqInv_eDNA <- bind_rows(JVB1470, JVB1554, JVB1703) %>%
  distinct(ESVId, site, .keep_all = TRUE) %>%
  filter(Kingdom != "Bacteria",
    
    # This cutoff is arbitrary and can be altered
    percent_match > 90)
  
```

## Vizualize data
```{r manual chart of aquatic taxa count}

taxa <- c(rep("order", 4), rep("family", 4), rep("species", 4))
site <- rep(c("NCOS West Pond" , "Vernal Pool 1", "Mouth of Devereux", "Venoco Bridge") , 3)

# Order columns
count <- c(NCOS_AqInv_eDNA %>% filter(site_name == "NWP") %>% count(Order) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "VP1") %>% count(Order) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "MO1") %>% count(Order) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "NVBR") %>% count(Order) %>% nrow(),

# Family columns          
           NCOS_AqInv_eDNA %>% filter(site_name == "NWP") %>% count(Family) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "VP1") %>% count(Family) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "MO1") %>% count(Family) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "NVBR") %>% count(Family) %>% nrow(),

# Species Columns
           NCOS_AqInv_eDNA %>% filter(site_name == "NWP") %>% count(Species) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "VP1") %>% count(Species) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "MO1") %>% count(Species) %>% nrow(),
           NCOS_AqInv_eDNA %>% filter(site_name == "NVBR") %>% count(Species) %>% nrow())


taxa_comparison <- data.frame(taxa, site, count)

ggplot(NCOS_AqInv_eDNA, aes(x = site_name)) + geom_bar(stat = "count") + ggtitle("Unique DNA Barcode Observations by Site") +
  geom_col

ggplot(taxa_comparison, aes(x = taxa, y = count, fill = site)) + 
    geom_bar(position="dodge", stat="identity") + ggtitle("Taxa Counts by Site")
```

```{r seasonal eDNA replication counts}
NCOS_AqInv_summary <- NCOS_AqInv_eDNA %>%
  group_by(date, site) %>%
  summarize(sum_sequence_replications = sum(sample_count),
            identified_taxa_count = n())

ggplot(NCOS_AqInv_summary) +
  geom_line(aes(x = date, 
                y = identified_taxa_count, 
                color = site)) +
  ylab("identified taxa")
  ggtitle("Count of Identified Taxa")

ggplot(NCOS_AqInv_summary) +
  geom_line(aes(x = date, 
                y = sum_sequence_replications, 
                color = site)) +
  ylab("DNA barcode replications") +
  ggtitle("Sum of DNA Barcode Replica Count")

NCOS_AqInv_eDNA %>%
  ggplot() +
    geom_line(aes(x = date, 
                  y = sample_count, 
                  color = Class)) +
    ylab("DNA barcode replications") +
    ggtitle("DNA barcode replications")
```

```{r aquatic species tree diagrams, fig.height=10, fig.width=18, warning=FALSE}

heatTree <- function(input, title) {
  input %>% parse_tax_data(class_cols = 5:11) %>%
  filter_taxa(taxon_names != "") %>%
  heat_tree(node_label = taxon_names,
            node_color = n_obs,
            node_size = n_obs,
            overlap_avoidance = 20,
            node_label_size_range = c(0.021, 0.026),
            repel_force = 10,
            node_legend_title = "Taxon",
            node_color_axis_label = "# DNA matches",
            node_color_digits = 1,
            title = title,
            title_size = 0.03,
            aspect_ratio = 1.8,
            margin_size = c(0.003, 0.003, 0.003, 0.003),
            layout = "da")
}

NCOS_AqInv_eDNA %>% heatTree(" Species found by eDNA in the Devereux Slough")

NCOS_AqInv_eDNA %>% filter(site_name == "NWP") %>% 
  heatTree(" Species detected at NCOS West Pond")

NCOS_AqInv_eDNA %>% filter(site_name == "VP1") %>% 
  heatTree(" Species detected at Vernal Pool 1")

NCOS_AqInv_eDNA %>% filter(site_name == "MO1") %>% 
  heatTree(" Species detected at Mouth of Devereux Slough")

NCOS_AqInv_eDNA %>% filter(site_name == "NVBR") %>% 
  heatTree(" Species detected at Venoco Bridge")

```

```{r nmds}
library(vegan)
library(ggrepel)

presence_AqInv_eDNA <- NCOS_AqInv_eDNA %>%
  mutate(presence = 1) %>%
  pivot_wider(id_cols = site, 
              names_from  = kpcofgs, 
              values_from = presence,
              values_fn = mean) %>%
  replace(is.na(.), 0) %>%
  filter(!row_number() %in% 14) # Remove last row with no presence

NMDS_AqInv_eDNA <- presence_AqInv_eDNA %>%
  select(2:50) %>%
  metaMDS(dist = "bray")

NCOScopr <- AQsampleIDs %>% 
  select(site, ncos_or_copr) %>%
  unique()

NMDS_AqInv_eDNA.scores <- as.data.frame(scores(NMDS_AqInv_eDNA)$sites) %>%
  mutate(site = presence_AqInv_eDNA$site) %>%
  left_join(NCOScopr, by = "site")

ggplot(NMDS_AqInv_eDNA.scores, aes(NMDS1, NMDS2, label = site, color = ncos_or_copr)) +
  geom_point() + geom_text_repel()


```


# Soils

## Load in data
```{r}

```



